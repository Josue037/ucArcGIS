<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Sorteo UC 2025 - Conferencia de usuarios Geotecnolog√≠as</title>
  <style>
    /* ====== ESTILO GLOBAL ====== */
    body { 
      font-family: 'Segoe UI', Arial, sans-serif;
      color: #fff;
      margin: 0;
      padding: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      overflow-x: hidden;
    }

    /* ====== VIDEO DE FONDO ====== */
    video#videoFondo {
      position: fixed;
      top: 0; left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      z-index: -1;
      filter: brightness(0.45);
    }

    /* ====== LOGO SUPERIOR IZQUIERDO ====== */
    #logoUC {
      position: fixed;
      top: 15px;
      left: 15px;
      width: 140px;
      opacity: 0.45;
      filter: drop-shadow(0 0 10px rgba(0,0,0,0.7));
      z-index: 10;
      transition: opacity 0.3s ease;
    }
    #logoUC:hover {
      opacity: 0.8;
    }

    h2 { 
      margin-top: 25px;
      text-shadow: 0 0 10px rgba(0,0,0,0.8);
      text-align: center;
    }

    #contenedor {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      align-items: flex-start;
      width: 100%;
      max-width: 1300px;
      gap: 20px;
      margin-top: 20px;
      background: rgba(0,0,0,0.3);
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 0 20px rgba(0,0,0,0.5);
    }

    #participantes, #ganadoresContainer {
      flex: 1;
      min-width: 220px;
      max-height: 80vh;
      overflow-y: auto;
      background: rgba(255,255,255,0.08);
      border-radius: 12px;
      padding: 15px;
      box-shadow: inset 0 0 8px rgba(255,255,255,0.2);
    }

    #participantes h3, #ganadoresContainer h3 {
      margin-top: 0;
      color: #ffe26f;
      text-align: center;
      text-shadow: 0 0 6px rgba(0,0,0,0.5);
    }

    .nombre {
      padding: 5px 8px;
      margin: 3px 0;
      border-radius: 8px;
      transition: background 0.3s, transform 0.2s;
    }

    .nombre:hover {
      transform: scale(1.05);
    }

    .activo {
      background: rgba(255,255,255,0.3);
      font-weight: bold;
      color: #00ffc3;
    }

    #ruletaContainer {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    canvas { 
      border-radius: 50%; 
      background: rgba(255,255,255,0.1);
      box-shadow: 0 0 25px rgba(0,0,0,0.6);
      transition: 0.4s;
      max-width: 50vw;
      height: auto;
    }

    #puntero {
      width: 0; 
      height: 0; 
      border-left: 25px solid transparent;
      border-right: 25px solid transparent;
      border-bottom: 35px solid #ff0000;
      margin: 0 auto 10px;
      transform: rotate(180deg);
      filter: drop-shadow(0 0 5px rgba(255,255,255,0.6));
    }

    #botones {
      display: flex;
      justify-content: center;
      margin-top: 10px;
      flex-wrap: wrap;
      gap: 10px;
    }

    button { 
      padding: 10px 18px; 
      font-size: 16px; 
      cursor: pointer; 
      border-radius: 10px;
      border: none;
      background: linear-gradient(135deg, #ffd54f, #ffb300);
      color: #000;
      font-weight: bold;
      transition: 0.3s;
      box-shadow: 0 4px 8px rgba(0,0,0,0.4);
    }

    button:hover {
      background: linear-gradient(135deg, #ffe082, #ffca28);
      transform: scale(1.05);
    }

    #selectorGrupo {
      margin-top: 10px;
      text-align: center;
    }

    /* ====== OVERLAY GANADOR ====== */
    #overlayGanador {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0);
      font-size: 42px;
      font-weight: bold;
      color: #00ffc3;
      text-shadow: 0 0 20px rgba(0,255,195,0.8);
      background: rgba(0,0,0,0.8);
      padding: 30px 50px;
      border-radius: 20px;
      z-index: 9999;
      text-align: center;
      transition: transform 0.4s ease, opacity 0.4s ease;
      opacity: 0;
    }

    #cerrarOverlay {
      position: absolute;
      top: 10px;
      right: 15px;
      background: none;
      color: #b26fff;
      font-weight: bold;
      font-size: 22px;
      border: none;
      border-radius: 50%;
      width: 35px;
      height: 35px;
      cursor: pointer;
      box-shadow: none;
    }

    /* ====== LOGOS ====== */
    .logos {
      display: flex;
      justify-content: center;
      align-items: center;
      margin: 30px 0 20px;
      gap: 30px;
    }

    .logos img {
      height: 60px;
      transition: transform 0.3s;
    }

    .logos img:hover {
      transform: scale(1.1);
    }

    @media (max-width: 850px) {
      #contenedor {
        flex-direction: column;
      }
      canvas {
        max-width: 70vw;
      }
    }
  </style>
</head>
<body>
  <!-- üé• VIDEO DE FONDO -->
  <video id="videoFondo" autoplay loop muted playsinline>
    <source src="https://nube.geotecnologias.co.cr/s/j9RAYEagMJQNrzB/download" type="video/mp4">
  </video>

  <!-- LOGO UC -->
  <link rel="icon" type="image/png" href="./img/uc_logo.png">

  <!-- T√çTULO PRINCIPAL -->
  <h2>Sorteo UC 2025 - Conferencia de usuarios Geotecnolog√≠as</h2>

  <div id="selectorGrupo">
    <button onclick="cambiarGrupo(0)">Ruleta 1</button>
    <button onclick="cambiarGrupo(1)">Ruleta 2</button>
    <button onclick="cambiarGrupo(2)">Ruleta 3</button>
  </div>

  <h3 id="tituloRuleta">Ruleta 1</h3>

  <div id="contenedor">
    <div id="participantes">
      <h3>Participantes</h3>
      <div id="listaParticipantes"></div>
    </div>

    <div id="ruletaContainer">
      <div id="puntero"></div>
      <canvas id="ruleta" width="400" height="400"></canvas>

      <div id="botones">
        <button onclick="girar()">üé≤ Girar</button>
        <button onclick="actualizarLista()">üîÑ Actualizar lista</button>
      </div>
    </div>

    <div id="ganadoresContainer">
      <h3>Ganadores</h3>
      <div id="listaGanadores"></div>
    </div>
  </div>

  <!-- üèÜ MENSAJE GANADOR -->
  <div id="overlayGanador">
    <button id="cerrarOverlay" onclick="cerrarOverlay()">‚úñÔ∏è</button>
    <div id="textoGanador"></div>
  </div>

  <!-- üñºÔ∏è LOGOS -->
  <div class="logos">
    <img src="./img/logoe.png" alt="Logo E">
    <img src="./img/logog.png" alt="Logo G">
  </div>

  <script>
    const url = "https://services1.arcgis.com/7ToOpQ2UUjs5M3iQ/ArcGIS/rest/services/Asistencia_Usuarios_Esri_Geotecnolog%C3%ADas_Honduras_2025_vista/FeatureServer/0/query?where=1%3D1&outFields=nombre,apellidos&returnGeometry=false&f=json";

    let nombres = [], grupos = [], grupoActual = 0, ganadores = [];
    let girando = false, startAngle = -Math.PI / 2, animFrame, ganadorTemporal = null;

    const canvas = document.getElementById("ruleta");
    const ctx = canvas.getContext("2d");

    const colores = [
      "#007bff", "#00bcd4", "#4caf50", "#ffeb3b", "#ff9800", "#e91e63",
      "#9c27b0", "#3f51b5", "#2196f3", "#009688", "#ff5722", "#cddc39",
      "#673ab7", "#8bc34a", "#f44336", "#03a9f4", "#795548", "#ffc107",
      "#00acc1", "#ff6f00"
    ];

    function ajustarCanvas() {
      let tama√±o = Math.min(window.innerWidth * 0.45, 500); 
      canvas.width = tama√±o;
      canvas.height = tama√±o;
      dibujarRuleta();
    }
    window.addEventListener("resize", ajustarCanvas);

    async function cargarDatos() {
      try {
        const res = await fetch(url);
        if (!res.ok) throw new Error("Error al obtener datos del servicio");
        const data = await res.json();

        nombres = data.features.map(f => `${f.attributes.nombre} ${f.attributes.apellidos}`.trim()).filter(Boolean);
        const tamanoGrupo = Math.ceil(nombres.length / 3);
        grupos = [];
        for (let i = 0; i < nombres.length; i += tamanoGrupo)
          grupos.push(nombres.slice(i, i + tamanoGrupo));

        cambiarGrupo(0);
      } catch (err) {
        console.error(err);
      }
    }

    function cambiarGrupo(indice) {
      if (!grupos[indice]) return;
      grupoActual = indice;
      nombres = grupos[grupoActual].filter(n => !ganadores.includes(n));
      document.getElementById("tituloRuleta").textContent = `Ruleta ${grupoActual + 1}`;
      actualizarListaParticipantes();
      dibujarRuleta();
    }

    function actualizarListaParticipantes() {
      const cont = document.getElementById("listaParticipantes");
      cont.innerHTML = "";
      nombres.slice(0,10).forEach(n => {
        const div = document.createElement("div");
        div.textContent = n;
        div.className = "nombre";
        cont.appendChild(div);
      });
    }

    function marcarActivo(nombre) {
      const cont = document.getElementById("listaParticipantes");
      cont.innerHTML = "";
      let indexActivo = nombres.indexOf(nombre);
      let inicio = Math.max(0, indexActivo - 4);
      let fin = Math.min(nombres.length, inicio + 10);
      for (let i = inicio; i < fin; i++) {
        const div = document.createElement("div");
        div.textContent = nombres[i];
        div.className = "nombre";
        if (nombres[i] === nombre) div.classList.add("activo");
        cont.appendChild(div);
      }
    }

    function dibujarRuleta() {
      if (nombres.length === 0) return;
      let num = nombres.length;
      let arc = 2 * Math.PI / num;
      let radio = canvas.width / 2;
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      for (let i = 0; i < num; i++) {
        let angle = startAngle + i * arc;
        ctx.fillStyle = colores[i % colores.length];
        ctx.beginPath();
        ctx.moveTo(radio, radio);
        ctx.arc(radio, radio, radio, angle, angle + arc);
        ctx.fill();

        ctx.save();
        ctx.fillStyle = "white";
        ctx.translate(radio, radio);
        ctx.rotate(angle + arc / 2);
        ctx.textAlign = "right";
        let texto = num > 40 ? nombres[i].split(" ").map(n => n[0]).join("") : nombres[i];
        ctx.font = `${Math.max(10, radio / (num > 30 ? 25 : 15))}px Arial`;
        ctx.fillText(texto, radio - 20, 10);
        ctx.restore();
      }
    }

    function girar() {
      if (girando || nombres.length === 0) return;
      girando = true;

      let vueltas = 5 + Math.random() * 2;
      let spinTime = 0;
      let spinTimeTotal = 8000 + Math.random() * 4000;
      let startAngleInicial = startAngle;
      let anguloFinal = startAngle + vueltas * 2 * Math.PI + Math.random() * 2 * Math.PI;

      function easeOutCubic(t) {
        return 1 - Math.pow(1 - t, 3);
      }

      function rotar() {
        spinTime += 30;
        let progress = Math.min(spinTime / spinTimeTotal, 1);
        let eased = easeOutCubic(progress);

        startAngle = startAngleInicial + (anguloFinal - startAngleInicial) * eased;
        startAngle %= 2 * Math.PI;
        dibujarRuleta();

        let num = nombres.length;
        let arc = 2 * Math.PI / num;
        let angulo = (startAngle + Math.PI / 2) % (2 * Math.PI);
        if (angulo < 0) angulo += 2 * Math.PI;
        let index = Math.floor((2 * Math.PI - angulo) / arc) % num;
        marcarActivo(nombres[index]);

        if (progress < 1) {
          animFrame = requestAnimationFrame(rotar);
        } else {
          detener();
          girando = false;
        }
      }

      rotar();
    }

    function mostrarGanadorOverlay(nombre) {
      const overlay = document.getElementById("overlayGanador");
      const texto = document.getElementById("textoGanador");
      texto.textContent = `üéâ Ganador: ${nombre}`;
      overlay.style.opacity = 1;
      overlay.style.transform = "translate(-50%, -50%) scale(1)";
    }

    function cerrarOverlay() {
      const overlay = document.getElementById("overlayGanador");
      overlay.style.opacity = 0;
      overlay.style.transform = "translate(-50%, -50%) scale(0)";

      if (ganadorTemporal) {
        const listaG = document.getElementById("listaGanadores");
        const item = document.createElement("div");
        item.textContent = ganadorTemporal;
        item.className = "nombre activo";
        listaG.prepend(item);

        const index = nombres.indexOf(ganadorTemporal);
        if (index > -1) nombres.splice(index, 1);
        actualizarListaParticipantes();
        if (nombres.length > 0) dibujarRuleta();

        ganadores.push(ganadorTemporal);
        ganadorTemporal = null;
      }
    }

    function detener() {
      cancelAnimationFrame(animFrame);
      let num = nombres.length;
      let arc = 2 * Math.PI / num;
      let angulo = (startAngle + Math.PI / 2) % (2 * Math.PI);
      if (angulo < 0) angulo += 2 * Math.PI;

      let index = Math.floor((2 * Math.PI - angulo) / arc) % num;
      let ganador = nombres[index];
      ganadorTemporal = ganador;
      mostrarGanadorOverlay(ganador);
    }

    function actualizarLista() {
      cargarDatos();
    }

    cargarDatos();
    ajustarCanvas();
  </script>
</body>
</html>

